<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LokWild - Look to Lock the Wild</title>
    <meta name="description" content="LokWild - Look to Lock the Wild | Nền tảng phát hiện đối tượng thông minh với YOLOv8, từ vật thể thường ngày đến động vật hoang dã">
    <meta name="keywords" content="LokWild, Wildlife Detection, AI Detection, YOLO, Computer Vision, Machine Learning">
    <meta name="author" content="LokWild - Look to Lock the Wild">
    <meta name="theme-color" content="#667eea">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABjklEQVRYhe2XzU7CQBSGX8AL8AoEjQkxJsQYY0yMiTHGmBhjjDHGGGOMCTHGGBNjjDEmxhhjTIwxJsYYY4yJMSbGmBhjjDEmxpgYY0yMMSbGGGOMCTHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGOMCTHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGOMCTHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGOMCTHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGNMiDHGmBhjjDEmxhhjTIwxJsYYY0yMMSbGGGP+GF8BnZJ1KG6hJ6YAAAAASUVORK5CYII=">
    
    <!-- External CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="/static/favicon.svg" alt="LokWild Logo" class="logo-svg">
                    </div>
                    <div class="logo-text">
                        <span class="brand-name">LokWild</span>
                        <span class="brand-slogan">Look to Lock the Wild</span>
                    </div>
                </div>
                
                <div id="connectionStatus" class="status-badge status-online">
                    <i class="fas fa-circle"></i>
                    <span>Online</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Model Selection & Upload Grid -->
            <div class="content-grid">
                <!-- Model Selection Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h2 class="card-title">Chọn AI Model</h2>
                    </div>
                    
                    <div class="model-selector" id="modelSelector">
                        <!-- Models will be loaded dynamically -->
                        <div class="model-loading">
                            <div class="spinner"></div>
                            <span>Đang tải danh sách models...</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h2 class="card-title">Tải lên hình ảnh</h2>
                    </div>
                    
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-content">
                            <div class="upload-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="upload-text">Kéo thả hình ảnh vào đây</div>
                            <div class="upload-hint">hoặc click để chọn file (JPG, PNG, GIF - Max 16MB)</div>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
            </div>

            <!-- Preview Section -->
            <div id="previewSection" class="card hidden">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <h2 class="card-title">Xem trước</h2>
                </div>
                
                <div class="preview-container">
                    <img id="previewImage" class="preview-image" alt="Preview">
                    
                    <div class="preview-actions">
                        <button id="detectBtn" class="btn btn-success">
                            <i class="fas fa-search"></i>
                            Phát hiện đối tượng
                        </button>
                        <button id="cancelBtn" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            Hủy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-container hidden">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h2 class="card-title">Kết quả phát hiện</h2>
                    </div>
                    
                    <!-- Metrics -->
                    <div id="metricsRow" class="metrics-row">
                        <!-- Metrics will be populated here -->
                    </div>
                    
                    <!-- Results Grid -->
                    <div class="results-grid">
                        <div class="image-container">
                            <img id="resultImage" class="result-image" alt="Result">
                        </div>
                        
                        <div>
                            <h3 class="mb-2">
                                <i class="fas fa-list"></i>
                                Chi tiết phát hiện
                            </h3>
                            <div id="predictionsList" class="predictions-container">
                                <!-- Predictions will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        class AIDetectionApp {
            constructor() {
                this.selectedModel = 'yolov8s';
                this.currentFile = null;
                this.isConnected = false;
                this.availableModels = {};
                
                this.initElements();
                this.initEventListeners();
                this.checkConnection();
                this.loadAvailableModels();
            }
            
            initElements() {
                this.connectionStatus = document.getElementById('connectionStatus');
                this.modelSelector = document.getElementById('modelSelector');
                this.uploadZone = document.getElementById('uploadZone');
                this.fileInput = document.getElementById('fileInput');
                this.previewSection = document.getElementById('previewSection');
                this.previewImage = document.getElementById('previewImage');
                this.detectBtn = document.getElementById('detectBtn');
                this.cancelBtn = document.getElementById('cancelBtn');
                this.resultsSection = document.getElementById('resultsSection');
                this.metricsRow = document.getElementById('metricsRow');
                this.resultImage = document.getElementById('resultImage');
                this.predictionsList = document.getElementById('predictionsList');
            }
            
            async loadAvailableModels() {
                try {
                    const response = await fetch('/api/models');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.availableModels = {};
                            data.models.forEach(model => {
                                this.availableModels[model.id] = model;
                            });
                            this.renderModelSelector(data.models);
                            this.selectedModel = data.current_model || 'yolov8s';
                        }
                    }
                } catch (error) {
                    console.error('Failed to load models:', error);
                    this.renderModelError();
                }
            }
            
            renderModelSelector(models) {
                const modelHTML = models.map(model => {
                    const requirementBadge = model.requirement === 1 
                        ? `<span class="requirement-badge req-1">Requirement 1</span>`
                        : `<span class="requirement-badge req-2">Requirement 2</span>`;
                    
                    return `
                        <div class="model-option ${model.is_current ? 'selected' : ''}" data-model="${model.id}">
                            <div class="model-info">
                                <div class="model-icon" style="color: ${model.color || '#667eea'};">
                                    <i class="${model.icon || 'fas fa-brain'}"></i>
                                </div>
                                <div class="model-details">
                                    <div class="model-header">
                                        <h4>${model.name}</h4>
                                        ${requirementBadge}
                                    </div>
                                    <p>${model.description}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.modelSelector.innerHTML = modelHTML;
                this.attachModelListeners();
            }
            
            renderModelError() {
                this.modelSelector.innerHTML = `
                    <div class="model-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Không thể tải danh sách models. Vui lòng kiểm tra kết nối.</p>
                        <button onclick="location.reload()" class="btn btn-primary">Thử lại</button>
                    </div>
                `;
            }
            
            attachModelListeners() {
                const modelOptions = this.modelSelector.querySelectorAll('.model-option');
                modelOptions.forEach(option => {
                    option.addEventListener('click', async () => {
                        const newModel = option.dataset.model;
                        if (newModel !== this.selectedModel) {
                            await this.switchModel(newModel, option);
                        }
                    });
                });
            }
            
            async switchModel(newModel, optionElement) {
                // Show loading state
                const originalHTML = optionElement.innerHTML;
                optionElement.innerHTML = `
                    <div class="model-switching">
                        <div class="spinner"></div>
                        <span>Đang chuyển model...</span>
                    </div>
                `;
                
                try {
                    const response = await fetch('/api/switch_model', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ model_name: newModel })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Update UI
                        this.modelSelector.querySelectorAll('.model-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        optionElement.classList.add('selected');
                        this.selectedModel = newModel;
                        
                        // Show appropriate message based on response
                        const message = data.reused 
                            ? data.message 
                            : data.message;
                        this.showNotification(message, 'success');
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    this.showNotification('Lỗi chuyển model: ' + error.message, 'error');
                } finally {
                    // Restore original content
                    optionElement.innerHTML = originalHTML;
                }
            }
            
            initEventListeners() {
                // Upload events
                this.uploadZone.addEventListener('click', () => this.fileInput.click());
                this.uploadZone.addEventListener('dragover', this.handleDragOver.bind(this));
                this.uploadZone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                this.uploadZone.addEventListener('drop', this.handleDrop.bind(this));
                
                // File input
                this.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
                
                // Action buttons
                this.detectBtn.addEventListener('click', this.runDetection.bind(this));
                this.cancelBtn.addEventListener('click', this.cancelPreview.bind(this));
            }
            
            async checkConnection() {
                try {
                    const response = await fetch('/api/health');
                    if (response.ok) {
                        this.isConnected = true;
                        this.connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Online</span>';
                        this.connectionStatus.className = 'status-badge status-online';
                    }
                } catch (error) {
                    this.isConnected = false;
                    this.connectionStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Offline</span>';
                    this.connectionStatus.style.background = 'rgba(245, 87, 108, 0.1)';
                    this.connectionStatus.style.color = '#f5576c';
                }
            }
            
            handleDragOver(e) {
                e.preventDefault();
                this.uploadZone.classList.add('dragover');
            }
            
            handleDragLeave(e) {
                e.preventDefault();
                this.uploadZone.classList.remove('dragover');
            }
            
            handleDrop(e) {
                e.preventDefault();
                this.uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.handleFile(files[0]);
                }
            }
            
            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.handleFile(file);
                }
            }
            
            handleFile(file) {
                // Validate file
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    this.showNotification('Loại file không được hỗ trợ!', 'error');
                    return;
                }
                
                if (file.size > 16 * 1024 * 1024) {
                    this.showNotification('File quá lớn! Tối đa 16MB.', 'error');
                    return;
                }
                
                this.currentFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.previewImage.src = e.target.result;
                    this.previewSection.classList.remove('hidden');
                    this.resultsSection.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            cancelPreview() {
                this.previewSection.classList.add('hidden');
                this.resultsSection.classList.add('hidden');
                this.currentFile = null;
                this.fileInput.value = '';
            }
            
            async runDetection() {
                if (!this.currentFile || !this.isConnected) {
                    this.showNotification('Vui lòng chọn file và kiểm tra kết nối!', 'error');
                    return;
                }
                
                // Show loading state
                this.detectBtn.innerHTML = '<div class="loading"><div class="spinner"></div>Đang phân tích...</div>';
                this.detectBtn.disabled = true;
                
                const formData = new FormData();
                formData.append('file', this.currentFile);
                formData.append('model', this.selectedModel);
                formData.append('confidence', '0.25');
                formData.append('iou', '0.45');
                
                try {
                    const response = await fetch('/api/predict', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayResults(data);
                        this.showNotification('Phát hiện hoàn thành!', 'success');
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                    
                } catch (error) {
                    console.error('Detection error:', error);
                    this.showNotification('Lỗi phát hiện: ' + error.message, 'error');
                } finally {
                    this.detectBtn.innerHTML = '<i class="fas fa-search"></i>Phát hiện đối tượng';
                    this.detectBtn.disabled = false;
                }
            }
            
            displayResults(data) {
                // Show results section
                this.resultsSection.classList.remove('hidden');
                
                // Display metrics
                const stats = data.stats || {};
                this.metricsRow.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${stats.total_objects || 0}</div>
                        <div class="metric-label">Đối tượng phát hiện</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(stats.classes_detected || []).length}</div>
                        <div class="metric-label">Loại khác nhau</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${stats.avg_confidence ? (stats.avg_confidence * 100).toFixed(1) : 0}%</div>
                        <div class="metric-label">Độ tin cậy TB</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${stats.max_confidence ? (stats.max_confidence * 100).toFixed(1) : 0}%</div>
                        <div class="metric-label">Độ tin cậy cao nhất</div>
                    </div>
                `;
                
                // Display result image
                if (data.result_image) {
                    this.resultImage.src = data.result_image;
                }
                
                // Display predictions
                const predictions = data.predictions || [];
                if (predictions.length === 0) {
                    this.predictionsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--light-text);">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>Không phát hiện đối tượng nào</p>
                        </div>
                    `;
                } else {
                    this.predictionsList.innerHTML = predictions.map((pred, index) => `
                        <div class="prediction-item">
                            <div class="prediction-header">
                                <span class="class-name">${pred.class || 'Unknown'}</span>
                                <span class="confidence-badge">${pred.confidence ? (pred.confidence * 100).toFixed(1) : 0}%</span>
                            </div>
                            <div class="prediction-details">
                                <i class="fas fa-map-marker-alt"></i> 
                                Vị trí: (${pred.bbox ? pred.bbox[0].toFixed(0) : 0}, ${pred.bbox ? pred.bbox[1].toFixed(0) : 0})
                                <br>
                                <i class="fas fa-expand-arrows-alt"></i> 
                                Kích thước: ${pred.width ? pred.width.toFixed(0) : 0} × ${pred.height ? pred.height.toFixed(0) : 0}px
                            </div>
                        </div>
                    `).join('');
                }
                
                // Scroll to results
                this.resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 1.5rem;
                    border-radius: var(--border-radius);
                    color: white;
                    font-weight: 500;
                    z-index: 1000;
                    transform: translateX(100%);
                    transition: var(--transition);
                    max-width: 400px;
                `;
                
                // Set background based on type
                if (type === 'success') {
                    notification.style.background = 'var(--success-gradient)';
                } else if (type === 'error') {
                    notification.style.background = 'var(--secondary-gradient)';
                } else {
                    notification.style.background = 'var(--accent-gradient)';
                }
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
        }
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AIDetectionApp();
        });
    </script>
</body>
</html>
